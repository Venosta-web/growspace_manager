============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.3.4, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
plugins: requests-mock-1.12.1, github-actions-annotate-failures-0.2.0, respx-0.21.1, cov-6.0.0, homeassistant-custom-component-0.13.205, xdist-3.6.1, syrupy-4.8.0, anyio-4.11.0, socket-0.7.0, asyncio-0.24.0, timeout-2.3.1, sugar-1.0.0, pytest_freezer-0.4.8, unordered-0.6.1, picked-0.5.0, aiohttp-1.0.5
asyncio: mode=Mode.AUTO, default_loop_scope=function
collected 11 items

tests/test_init.py ...F.......                                           [100%]

=================================== FAILURES ===================================
____________________________ test_register_services ____________________________

mock_hass = <MagicMock spec='HomeAssistant' id='140008662000720'>
mock_coordinator_for_services = <MagicMock id='140008672458848'>
mock_strain_library_for_services = <MagicMock id='140008672455008'>

    @pytest.mark.asyncio
    async def test_register_services(
        mock_hass, mock_coordinator_for_services, mock_strain_library_for_services
    ):
        """Test that _register_services correctly registers all services."""
        mock_hass.services.async_register = AsyncMock()

>       await _register_services(
            mock_hass, mock_coordinator_for_services, mock_strain_library_for_services
        )

tests/test_init.py:137:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

hass = <MagicMock spec='HomeAssistant' id='140008662000720'>
coordinator = <MagicMock id='140008672458848'>
strain_library_instance = <MagicMock id='140008672455008'>

    async def _register_services(
        hass: HomeAssistant,
        coordinator: GrowspaceCoordinator,
        strain_library_instance: StrainLibrary,
    ) -> None:
        """Register all Growspace Manager services."""

        # Define all services with their handler functions and schemas
        services_to_register = [
            ("add_growspace", growspace.handle_add_growspace, ADD_GROWSPACE_SCHEMA),
            (
                "remove_growspace",
                growspace.handle_remove_growspace,
                REMOVE_GROWSPACE_SCHEMA,
            ),
            ("add_plant", plant.handle_add_plant, ADD_PLANT_SCHEMA),
            ("update_plant", plant.handle_update_plant, UPDATE_PLANT_SCHEMA),
            ("remove_plant", plant.handle_remove_plant, REMOVE_PLANT_SCHEMA),
            ("move_plant", plant.handle_move_plant, MOVE_PLANT_SCHEMA),
            ("switch_plants", plant.handle_switch_plants, SWITCH_PLANT_SCHEMA),
            (
                "transition_plant_stage",
                plant.handle_transition_plant_stage,
                TRANSITION_PLANT_SCHEMA,
            ),
            ("take_clone", plant.handle_take_clone, TAKE_CLONE_SCHEMA),
            ("move_clone", plant.handle_move_clone, MOVE_CLONE_SCHEMA),
            ("harvest_plant", plant.handle_harvest_plant, HARVEST_PLANT_SCHEMA),
            (
                "export_strain_library",
                strain_library_services.handle_export_strain_library,
                EXPORT_STRAIN_LIBRARY_SCHEMA,
            ),
            (
                "import_strain_library",
                strain_library_services.handle_import_strain_library,
                IMPORT_STRAIN_LIBRARY_SCHEMA,
            ),
            (
                "clear_strain_library",
                strain_library_services.handle_clear_strain_library,
                CLEAR_STRAIN_LIBRARY_SCHEMA,
            ),
            (
                "add_strain",
                strain_library_services.handle_add_strain,
                ADD_STRAIN_SCHEMA,
            ),
            (
                "remove_strain",
                strain_library_services.handle_remove_strain,
                REMOVE_STRAIN_SCHEMA,
            ),
            (
                "update_strain_meta",
                strain_library_services.handle_update_strain_meta,
                UPDATE_STRAIN_META_SCHEMA,
            ),
            ("test_notification", debug.handle_test_notification, None),
            (
                "debug_cleanup_legacy",
                debug.debug_cleanup_legacy,
                DEBUG_CLEANUP_LEGACY_SCHEMA,
            ),
            (
                "debug_list_growspaces",
                debug.debug_list_growspaces,
                DEBUG_LIST_GROWSPACES_SCHEMA,
            ),
            (
                "debug_reset_special_growspaces",
                debug.debug_reset_special_growspaces,
                DEBUG_RESET_SPECIAL_GROWSPACES_SCHEMA,
            ),
            (
                "debug_consolidate_growspaces",
                debug.debug_consolidate_duplicate_special,
                DEBUG_CONSOLIDATE_DUPLICATE_SPECIAL_SCHEMA,
            ),
            (
                "configure_environment",
                environment.handle_configure_environment,
                CONFIGURE_ENVIRONMENT_SCHEMA,
            ),
            (
                "remove_environment",
                environment.handle_remove_environment,
                REMOVE_ENVIRONMENT_SCHEMA,
            ),
        ]

        # Register services using a wrapper to pass necessary context
        for service_name, handler_func, schema in services_to_register:

            async def service_wrapper(call: ServiceCall, _handler=handler_func):
                await _handler(hass, coordinator, strain_library_instance, call)

            hass.services.async_register(
                DOMAIN, service_name, service_wrapper, schema=schema
            )
            _LOGGER.debug("Registered service: %s", service_name)

        # Register ask_grow_advice with supports_response
        async def ask_grow_advice_wrapper(
            call: ServiceCall, _handler=growspace.handle_ask_grow_advice
        ):
             return await _handler(hass, coordinator, strain_library_instance, call)

        hass.services.async_register(
>           DOMAIN, "ask_grow_advice", ask_grow_advice_wrapper, schema=ASK_GROW_ADVICE_SCHEMA, supports_response=SupportsResponse.ONLY
        )
E       NameError: name 'ASK_GROW_ADVICE_SCHEMA' is not defined

custom_components/growspace_manager/__init__.py:251: NameError
=============================== warnings summary ===============================
tests/test_init.py::test_register_services
  /app/custom_components/growspace_manager/__init__.py:239: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
  Coroutine created at (most recent call last)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
      result = testfunction(**testargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 929, in inner
      _loop.run_until_complete(task)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
      self.run_forever()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
      self._run_once()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 1991, in _run_once
      handle._run()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/events.py", line 88, in _run
      self._context.run(self._callback, *self._args)
    File "/app/tests/test_init.py", line 137, in test_register_services
      await _register_services(
    File "/app/custom_components/growspace_manager/__init__.py", line 239, in _register_services
      hass.services.async_register(
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1139, in __call__
      return self._mock_call(*args, **kwargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1143, in _mock_call
      return self._execute_mock_call(*args, **kwargs)
    hass.services.async_register(
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_init.py::test_async_unload_entry
  /app/custom_components/growspace_manager/__init__.py:343: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
  Coroutine created at (most recent call last)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
      result = testfunction(**testargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 929, in inner
      _loop.run_until_complete(task)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
      self.run_forever()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
      self._run_once()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 1991, in _run_once
      handle._run()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/events.py", line 88, in _run
      self._context.run(self._callback, *self._args)
    File "/app/tests/test_init.py", line 218, in test_async_unload_entry
      assert await async_unload_entry(mock_hass, entry)
    File "/app/custom_components/growspace_manager/__init__.py", line 343, in async_unload_entry
      hass.services.async_remove(DOMAIN, service_name)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1139, in __call__
      return self._mock_call(*args, **kwargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1143, in _mock_call
      return self._execute_mock_call(*args, **kwargs)
    hass.services.async_remove(DOMAIN, service_name)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_init.py::test_async_unload_entry_with_dynamic_entities
  /app/custom_components/growspace_manager/__init__.py:343: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
  Coroutine created at (most recent call last)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
      result = testfunction(**testargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 929, in inner
      _loop.run_until_complete(task)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
      self.run_forever()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
      self._run_once()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 1991, in _run_once
      handle._run()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/events.py", line 88, in _run
      self._context.run(self._callback, *self._args)
    File "/app/tests/test_init.py", line 236, in test_async_unload_entry_with_dynamic_entities
      assert await async_unload_entry(mock_hass, entry)
    File "/app/custom_components/growspace_manager/__init__.py", line 343, in async_unload_entry
      hass.services.async_remove(DOMAIN, service_name)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1139, in __call__
      return self._mock_call(*args, **kwargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1143, in _mock_call
      return self._execute_mock_call(*args, **kwargs)
    hass.services.async_remove(DOMAIN, service_name)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_init.py::test_async_unload_entry_with_unknown_dynamic_entities
  /app/custom_components/growspace_manager/__init__.py:343: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
  Coroutine created at (most recent call last)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
      result = testfunction(**testargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 929, in inner
      _loop.run_until_complete(task)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
      self.run_forever()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
      self._run_once()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 1991, in _run_once
      handle._run()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/events.py", line 88, in _run
      self._context.run(self._callback, *self._args)
    File "/app/tests/test_init.py", line 252, in test_async_unload_entry_with_unknown_dynamic_entities
      assert await async_unload_entry(mock_hass, entry)
    File "/app/custom_components/growspace_manager/__init__.py", line 343, in async_unload_entry
      hass.services.async_remove(DOMAIN, service_name)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1139, in __call__
      return self._mock_call(*args, **kwargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1143, in _mock_call
      return self._execute_mock_call(*args, **kwargs)
    hass.services.async_remove(DOMAIN, service_name)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_init.py::test_async_unload_entry_last_entry
  /app/custom_components/growspace_manager/__init__.py:343: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
  Coroutine created at (most recent call last)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
      result = testfunction(**testargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 929, in inner
      _loop.run_until_complete(task)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 678, in run_until_complete
      self.run_forever()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 645, in run_forever
      self._run_once()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/base_events.py", line 1991, in _run_once
      handle._run()
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/asyncio/events.py", line 88, in _run
      self._context.run(self._callback, *self._args)
    File "/app/tests/test_init.py", line 264, in test_async_unload_entry_last_entry
      assert await async_unload_entry(mock_hass, entry)
    File "/app/custom_components/growspace_manager/__init__.py", line 343, in async_unload_entry
      hass.services.async_remove(DOMAIN, service_name)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1139, in __call__
      return self._mock_call(*args, **kwargs)
    File "/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py", line 1143, in _mock_call
      return self._execute_mock_call(*args, **kwargs)
    hass.services.async_remove(DOMAIN, service_name)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_init.py::test_register_services - NameError: name 'ASK_GROW...
=================== 1 failed, 10 passed, 5 warnings in 0.61s ===================
